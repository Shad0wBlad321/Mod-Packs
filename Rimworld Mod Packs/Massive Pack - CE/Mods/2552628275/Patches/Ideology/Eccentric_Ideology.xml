<?xml version="1.0" encoding="utf-8" ?>
<Patch>

  <Operation Class="PatchOperationFindMod">
    <mods>
      <li>Ideology</li>
    </mods>
    <match Class="PatchOperationSequence">
      <operations>

        <!-- Spawned Ground Items -->
        <li Class="PatchOperationAdd">
          <xpath>Defs</xpath>
          <value>
            <ThingDef ParentName="EccentricGlowingChemlightBase">
              <defName>EccentricGlowingChemlightDarklight</defName>
              <label>glowing darklight chemlight</label>
              <comps>
                <li Class="CompProperties_Glower">
                  <glowRadius>6</glowRadius>
                  <glowColor>(78,226,229,0)</glowColor>
                </li>
                <li Class="CompProperties_Lifespan">
                  <lifespanTicks>7200</lifespanTicks>
                </li>
              </comps>
              <graphicData>
                <texPath>Things/Projectile/Eccentric/Chemlight_Darklight</texPath>
                <graphicClass>Graphic_Single</graphicClass>
                <shaderType>TransparentPostLight</shaderType>
              </graphicData>
            </ThingDef>
          </value>
        </li>

        <!-- Projectiles -->
        <li Class="PatchOperationAdd">
          <xpath>Defs</xpath>
          <value>
            <ThingDef ParentName="BaseGrenadeProjectile">
              <defName>Proj_EccentricChemlightDarklight</defName>
              <label>chemlight</label>
              <thingClass>Projectile_Explosive</thingClass>
              <graphicData>
                <texPath>Things/Projectile/Eccentric/Chemlight_Darklight</texPath>
                <graphicClass>Graphic_Single</graphicClass>
              </graphicData>
              <projectile>
                <explosionRadius>.5</explosionRadius>
                <damageDef>Stun</damageDef>
                <damageAmountBase>0</damageAmountBase>
                <explosionDelay>0</explosionDelay>
                <speed>12</speed>
                <flyOverhead>false</flyOverhead>
                <soundExplode>Interact_BeatFire</soundExplode>
                <preExplosionSpawnThingDef>EccentricGlowingChemlightDarklight</preExplosionSpawnThingDef>
              </projectile>
            </ThingDef>
          </value>
        </li>

        <!-- Weapons -->
        <li Class="PatchOperationAdd">
          <xpath>Defs</xpath>
          <value>
            <ThingDef ParentName="EccentricChemlightBase">
              <defName>EccentricChemlightDarklight</defName>
              <label>darklight chemlight</label>
              <description>A plastic tube filled with luminescent chemicals that produces darklight when used.</description>
              <graphicData>
                <texPath>Things/Ammo/Eccentric/Chemlight/Darklight/Darklight_a</texPath>
                <graphicClass>Graphic_Single</graphicClass>
              </graphicData>
              <verbs>
                <li>
                  <label>throw chemlight</label>
                  <verbClass>Verb_LaunchProjectile</verbClass>
                  <hasStandardCommand>true</hasStandardCommand>
                  <range>12.9</range>
                  <forcedMissRadius>1.9</forcedMissRadius>
                  <warmupTime>1.5</warmupTime>
                  <noiseRadius>4</noiseRadius>
                  <ai_IsBuildingDestroyer>false</ai_IsBuildingDestroyer>
                  <soundCast>Interact_BeatFire</soundCast>
                  <targetParams>
                    <canTargetLocations>true</canTargetLocations>
                  </targetParams>
                  <defaultProjectile>Proj_EccentricChemlightDarklight</defaultProjectile>
                  <onlyManualCast>true</onlyManualCast>
                  <rangedFireRulepack>Combat_RangedFire_Thrown</rangedFireRulepack>
                </li>
              </verbs>
            </ThingDef>
          </value>
        </li>

        <!--==== Ideology + Combat Extended ====-->
        <li Class="PatchOperationFindMod">
          <mods>
            <li>Combat Extended</li>
          </mods>
          <match Class="PatchOperationSequence">
            <operations>
              
              <li Class="PatchOperationAdd">
                <xpath>Defs</xpath>
                <value>
                  <RecipeDef ParentName="GrenadeRecipeBase">
                    <defName>MakeChemlightDarklight</defName>
                    <label>make darklight chemlights x10</label>
                    <description>Craft 10 darklight chemlights.</description>
                    <jobString>Making darklight chemlights.</jobString>
                    <ingredients>
                      <li>
                        <filter>
                          <thingDefs>
                            <li>Chemfuel</li>
                          </thingDefs>
                        </filter>
                        <count>10</count>
                      </li>
                    </ingredients>
                    <fixedIngredientFilter>
                      <thingDefs>
                        <li>Chemfuel</li>
                      </thingDefs>
                    </fixedIngredientFilter>
                    <workAmount>5000</workAmount>
                    <products>
                      <EccentricChemlightDarklight>10</EccentricChemlightDarklight>
                    </products>
                  </RecipeDef>
                </value>
              </li>

              <li Class="PatchOperationReplace">
                <xpath>Defs/ThingDef[defName="Proj_EccentricChemlightDarklight"]</xpath>
                <value>
                  <ThingDef ParentName="BaseGrenadeProjectile">
                    <defName>Proj_EccentricChemlightDarklight</defName>
                    <label>flare</label>
                    <thingClass>CombatExtended.ProjectileCE_Explosive</thingClass>
                    <graphicData>
                      <texPath>Things/Projectile/Eccentric/Chemlight_Darklight</texPath>
                      <graphicClass>Graphic_Single</graphicClass>
                    </graphicData>
                    <projectile Class="CombatExtended.ProjectilePropertiesCE">
                      <explosionRadius>.1</explosionRadius>
                      <damageDef>Stun</damageDef>
                      <damageAmountBase>0</damageAmountBase>
                      <explosionDelay>0</explosionDelay>
                      <speed>12</speed>
                      <flyOverhead>false</flyOverhead>
                      <ai_IsIncendiary>true</ai_IsIncendiary>
                      <soundExplode>Interact_BeatFire</soundExplode>
                      <preExplosionSpawnThingDef>EccentricGlowingChemlightDarklight</preExplosionSpawnThingDef>
                      <preExplosionSpawnChance>1</preExplosionSpawnChance>
                      <dropsCasings>false</dropsCasings>
                    </projectile>
                  </ThingDef>
                </value>
              </li>

              <li Class="PatchOperationReplace">
                <xpath>Defs/ThingDef[defName="EccentricChemlightDarklight"]</xpath>
                <value>
                  <ThingDef ParentName="BaseGrenadeEquipment" Class="CombatExtended.AmmoDef">
                    <defName>EccentricChemlightDarklight</defName>
                    <label>darklight chemlight</label>
                    <description>A plastic tube filled with luminescent chemicals that produces darklight when used.</description>
                    <thingClass>CombatExtended.AmmoThing</thingClass>
                    <stackLimit>75</stackLimit>
                    <resourceReadoutPriority>First</resourceReadoutPriority>
                    <tickerType>Normal</tickerType>
                    <graphicData>
                      <texPath>Things/Ammo/Eccentric/Chemlight/Darklight</texPath>
                      <graphicClass>Graphic_StackCount</graphicClass>
                    </graphicData>
                    <soundInteract>Interact_BeatFire</soundInteract>
                    <techLevel>Industrial</techLevel>
                    <statBases>
                      <Mass>0.5</Mass>
                      <MarketValue>3</MarketValue>
                      <SightsEfficiency>1</SightsEfficiency>
                      <RangedWeapon_Cooldown>1.33</RangedWeapon_Cooldown>
                    </statBases>
                    <weaponTags Inherit="False">
                      <li>EccentricChemlight</li>
                    </weaponTags>
                    <equippedAngleOffset>-45</equippedAngleOffset>
                    <thingCategories>
                      <li>Grenades</li>
                    </thingCategories>
                    <verbs>
                      <li Class="CombatExtended.VerbPropertiesCE">
                        <label>throw chemlight</label>
                        <verbClass>CombatExtended.Verb_ShootCEOneUse</verbClass>
                        <hasStandardCommand>true</hasStandardCommand>
                        <range>10</range>
                        <warmupTime>1.0</warmupTime>
                        <noiseRadius>4</noiseRadius>
                        <ai_IsBuildingDestroyer>false</ai_IsBuildingDestroyer>
                        <soundCast>Interact_BeatFire</soundCast>
                        <targetParams>
                          <canTargetLocations>true</canTargetLocations>
                        </targetParams>
                        <defaultProjectile>Proj_EccentricChemlightDarklight</defaultProjectile>
                        <onlyManualCast>true</onlyManualCast>
                        <rangedFireRulepack>Combat_RangedFire_Thrown</rangedFireRulepack>
                        <ignorePartialLoSBlocker>true</ignorePartialLoSBlocker>
                      </li>
                    </verbs>
                  </ThingDef>
                </value>
              </li>

            </operations>
          </match>
        </li>
        
      </operations>
    </match>
  </Operation>
</Patch>
